// @bun
var F=function(j,B,Y,Q){var Z=arguments.length,$=Z<3?B:Q===null?Q=Object.getOwnPropertyDescriptor(B,Y):Q,V;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")$=Reflect.decorate(j,B,Y,Q);else for(var N=j.length-1;N>=0;N--)if(V=j[N])$=(Z<3?V($):Z>3?V(B,Y,$):V(B,Y))||$;return Z>3&&$&&Object.defineProperty(B,Y,$),$};var y=(j,B)=>{if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(j,B)};var{file:oj,inflateSync:pj,serve:sj,write:rj}=globalThis.Bun;import{Auth as tj}from"authored";import{config as aj}from"dotenv";import{mkdirSync as Rj,writeFileSync as wj}from"fs";function e(j){let B;return class extends j{constructor(...Y){if(B)return B;super(...Y);B=this}}}function jj(j){return class extends j{constructor(...B){super(...B);let Y=new Map;return new Proxy(this,{get(Q,Z){let $=`__${Z}`;if(!Y.has($))Y.set($,Q[Z]);return Y.get($)},set(Q,Z,$){return Q[Z]=$,!0}})}}}class Bj{static set p(j){if(Array.isArray(j))console.log(...j);else console.log(j)}}var Aj=(j)=>Array.from({length:j},(B,Y)=>Y),xj="ABCDEFGHIJKLMNOPQRSTUVWXYZ",_j="abcdefghijklmnopqrstuvwxyz",Fj=Aj(10).join(""),$0=new RegExp(/(\d+)(\d*)/,"m");var yj=(j)=>{return!isNaN(parseFloat(j))&&isFinite(j)};var Qj=(j)=>{return j instanceof Uint8Array||j instanceof ArrayBuffer||typeof j==="string"};var Yj=(j)=>typeof j==="boolean",A=(j)=>typeof j==="string",Zj=(j)=>Array.isArray(j);var $j=(j,B="")=>{try{return wj(j,B,{flag:"wx"}),!0}catch(Y){return!1}},Vj=(j)=>{return Rj(j,{recursive:!0}),!0};var{keys:Nj,entries:O,hasOwn:V0}=Object;var E=Object.assign,X=(j)=>{return Object.keys(j).length},k=(j,B)=>j.replace(new RegExp(`^${B}|${B}$`,"g"),"");var i=(j)=>JSON.stringify(j),Gj=(j)=>{return JSON.parse(j)};var Kj=(j,B)=>{let[Y,Q]=B.replace(/bytes=/,"").split("-").map((Z,$)=>{let V=parseInt(Z,10);return isNaN(V)?$===0?0:j-1:V});return[Y,Q,j]},Uj=(j,B)=>{return j.reduce((Y,Q,Z)=>{return Y[Q]=B[Z],Y},{})},Wj=(j,B=!1)=>{if(yj(j))return Number.isInteger(j)?[j,"int"]:[j,"float"];if(B&&j.includes("."))return[j,"file"];if(j==="/")return[j,"-"];if(j.length===36&&j.match(/\-/g)?.length===4)return[j,"uuid"];return[j,"string"]};function f(j){let B=j.startsWith("/")?j:"/"+j,Y=B.match(/(?<=\/)[^/].*?(?=\/|$)/g)??["/"],[Q,Z]=Y.reduce(([$,V],N)=>{if(N.includes("<")){let G=N.match(/(?<=<)[^/].*?(?=>|$)/g);if(G?.length){let[H,W]=G[0].split(":");$.push(H),V.push(W)}}else $.push(N);return[$,V]},[[],[]]);if(B.endsWith("/")&&B.length>1)Q.push("/");return{parsed:Q,args:Z}}class T{date;constructor(j){this.date=j?new Date(j):new Date}delta(j=null,B=!1){let Y=T.delta(this.date.getTime(),j);return B?new Date(Y):Y}timed(j){if(!j)return this.date;return[["year","FullYear"],["month","Month"],["day","Date"],["hour","Hours"],["minute","Minutes"],["second","Seconds"]].reduce((Y,[Q,Z])=>{let $=j[Q];return $?new Date(Y[`set${Z}`](Y[`get${Z}`]()+$)):Y},new Date(this.date))}static delta(j,B=null){return B?B-j:j-Date.now()}static get now(){return Date.now()}}var P=(j)=>{let B=xj+_j;return Array.from({length:j},(Y,Q)=>B+(Q?Fj:"")).reduce((Y,Q)=>{return Y+=Q.charAt(Math.floor(Math.random()*Q.length))},"")};var{deflateSync:fj,gzipSync:Tj}=globalThis.Bun;import{JWTInterface as Sj}from"authored";class R{route;status;x_args;isFile;headers=new Headers({"Content-Type":"text/plain"});deflate;gzip;constructor({route:j,status:B=404,headers:Y={}},Q){if(this.status=B||404,this.route=j,this.x_args=Q||[],Y)this.header=Y;E(this,{status:B}),this.isFile=!!j?.isFile,this.deflate=(Z)=>{let $=fj(Z);return this.header={"Content-Length":$.byteLength.toString(),"Content-Encoding":"deflate"},$},this.gzip=(Z)=>{let $=Tj(Z);return this.header={"Content-Length":$.byteLength.toString(),"Content-Encoding":"gzip"},$}}set header(j){O(j).forEach(([B,Y])=>{this.headers.set(B,Y)})}set type(j){this.headers.set("Content-Type",j)}options(j,B={}){return j+=", OPTIONS",new Response("",{status:204,headers:{Allow:j,"Access-Control-Allow-Methods":j,"Access-Control-Max-Age":"86400",...B}})}}class M{static headstr="";headattr={};head;constructor(){this.head=(j)=>{O(j).forEach(([B,Y])=>{if(B=="title"||B=="base")this.headattr[B]=Y;else if(!(B in this.headattr))this.headattr[B]=Y;else this.headattr[B].push(...Y)})}}}class Hj{}class d extends M{lang="en";status;stream;__session;__jwt;headers={};set header(j){E(this.headers,j)}get header(){return this.headers}set type(j){this.header={"Content-Type":j}}get session(){if(!this.__session)this.__session=U.session.new;return this.__session}set session(j){this.__session=j}get jwt(){if(!this.__jwt)this.__jwt=U.jwt.new;return this.__jwt}set jwt(j){this.__jwt=j}get timedJWT(){return U.jwtInt.jwt()}setCookie({key:j,val:B,path:Y="/",days:Q=31,httpOnly:Z=!1}){let $=uj(j,B,{expires:new T().timed({day:Q}),path:Y,httpOnly:Z,sameSite:"Strict"});this.header={"Set-Cookie":$}}deleteCookie(j){this.setCookie({key:j,val:"",days:0})}}var uj=(j,B="",{maxAge:Y,expires:Q,path:Z,domain:$,secure:V,httpOnly:N,sameSite:G})=>{if(Y instanceof Date)Y=Y.getSeconds();if(Q instanceof Date)Q=Q.toUTCString();else if(Q===0)Q=new Date().toUTCString();return[["Domain",$],["Expires",Q],["Max-Age",Y],["Secure",V],["HttpOnly",N],["Path",Z],["SameSite",G]].reduce((W,[w,z])=>{if(z!==void 0)W.push(`${w}=${z}`);return W},[`${j}=${B}`]).join("; ")};class h{j;intervalID=[];constructor(j){this.ctrl=j}push(j,B=2000){if(this.ctrl){let Y=setInterval(()=>{let{id:Q,retry:Z,data:$,event:V,end:N}=j();if(this.ctrl){let G=N?"end":$;if(Z){let H=Z>2000?Z:2000;this.ctrl.enqueue(`retry: ${H}\\n`)}if(this.ctrl.enqueue(`id: ${Q}\\n`),V&&this.ctrl.enqueue(`event: ${V}\\n`),typeof G=="object")this.ctrl.enqueue("data: "+JSON.stringify(G)+"\\n\\\n");else this.ctrl.enqueue("data: "+JSON.stringify({message:G})+"\\n\\n");N&&this.close()}},B>1000?B:1000);this.intervalID.push(Y)}}close(){if(this.intervalID.length)this.intervalID.forEach((j)=>{clearInterval(j)}),this.intervalID=[];this.ctrl?.close()}}class S{session;jwt;jwtInt;constructor(){this.jwtInt=new Sj}init(j){this.session=j.session,this.jwt=j.jwt}}S=F([e,y("design:paramtypes",[])],S);var U=new S;var{file:Jj,gzipSync:gj}=globalThis.Bun;class o{j;B;Y;Q;Z;$;bytes;parsed=[];args=[];fileType="text/plain";constructor(j,B,Y={},Q=!1,Z=!1,$=""){this.path=j;this.proto=B;this.config=Y;this.isWSS=Q;this.isFile=Z;this.options=$;if(E(this,f(j)),Z)this.fileType=Jj(j).type}async loadbytes(j){if(this.config.preload)try{let B=await Jj(j+this.path).bytes();this.bytes=gj(B)}catch{throw`error: can't preload ${this.path}. File not found.`}return this}}var{setPath:u,getPath:Ij,setFolder:bj}=function(){let j=["string","int","float","file","uuid"],B=["GET","POST","PUT","DELETE","OPTIONS"],Y=new Map,Q=new Map,Z=new Map,$=new Map,V=(K,J)=>{return K?Q:J?Z:Y},N=(K)=>{let J=K.slice().pop();return J?Wj(J,!0).pop()==="file":!1},G=(K)=>{return B.filter((J)=>K[J.toLowerCase()]).join(", ")},H=(K)=>{let{path:J,parsed:q,isFile:L,isWSS:D}=K,I=V(D,L),b=JSON.stringify(q);if(!I.get(b))I.set(b,K);else if(!L)throw`path: ${J} already declared.`};function W(K,J={}){K=k(K,"."),K=k(K,"/"),$.set(K,J)}function w({isFile:K,parsed:J,path:q}){if(!K)return new R({});let L=J.slice(0,-1).join("/");for(let[D,I]of $.entries())if(L.startsWith(D))return new R({route:new o(`.${q}`,null,{requireSession:!!I?.requireSession},!1,K),status:200});return new R({})}function z(K,J,q,L,D){return(I)=>{let b=new o(K,I.prototype,J,q,L,G(I.prototype));if(D)b.loadbytes(D);return H(b),I}}function Cj({parsed:K,isWSS:J=!1,path:q}){let L=N(K),D=[],I=V(J,L),b=I.get(i(K));if(!b){let _=[];for(let Pj of I.keys()){let t=Gj(Pj),a=t.length;if(K.length===a)for(let C=0;C<a;C++){let m=K[C],v=t[C];if(v===m)_[C]=m;else if(j.includes(v))_[C]=v,D.push(m)}}b=I.get(i(_))}if(b)return new R({route:b,status:200},D);else return w({isFile:L,parsed:K,path:q})}return{setPath:z,getPath:Cj,setFolder:W}}();var g=new Map;class p{j;ws;path;id;broadcasting=!1;max=0;constructor(j){this.request=j;this.path=j.path,this.id=P(10)}async open(){}async message(j){}async close(j,B){}set send(j){if(j)if(this.broadcasting)this.ws.publish(this.path,j);else this.ws.send(j)}get role(){let j=g.get(this.path);if(j&&this.id in j)return j[this.id].role}get session(){if(!this.__session)this.__session=U.session.new;return this.__session}set session(j){this.__session=j}get jwt(){if(!this.__jwt)this.__jwt=U.jwt.new;return this.__jwt}set jwt(j){this.__jwt=j}get timedJWT(){return U.jwtInt.jwt()}}class Lj{async open(){}async message(j){}async close(j,B){}max=0;broadcasting=!1}var Dj=(j)=>{if(!g.get(j))g.set(j,{});return g.get(j)??{}},Oj={async open(j){let B=j.data.wclass,{z_args:Y,client:Q}=j.data;if(B){B.ws=j;let Z=B.id,$=X(Q);if(!(Z in Q)){let V=$?"joiner":"maker";Q[Z]={role:V}}if(typeof B.init=="function")await B.init(Y);if(B.broadcasting)B.ws.subscribe(B.path);await B.open()}else j.close()},async message(j,B){let Y=j.data.wclass;if(Y)await Y.message(B)},async close(j,B,Y){let Q=j.data.wclass,Z=j.data.client;if(Q){if(await Q.close(B,Y),Q.broadcasting)Q.ws.unsubscribe(Q.path);let $=Q.id;if(delete Z[$],X(Z)===1)Nj(Z).forEach((V,N)=>{Z[V].role="maker"})}}};var{file:nj}=globalThis.Bun;import{ServerSide as cj}from"authored";var{Server:lj}=globalThis.Bun;class x{j;B;formData;url;method;__cookies=new Map;constructor(j,B){this.req=j;this.server=B;this.url=new URL(j.url),this.method=this.req.method.toLowerCase()}async form(){if(this.isForm){if(!this.formData)this.formData=await this.req.formData();return this.formData}return new FormData}async authgroup(){let{cookies:j,auth:B}=this,Y=j.get("session")??"",Q=B??"",Z="",$=this.isForm?await this.form():void 0;if($){let V=$.get("refresh_token");Z=V?V.toString():""}return{sid:Y,jwtv:Q,refreshjwt:Z}}upgradeConnection(j={}){return!!this.server?.upgrade(this.req,j)}get auth(){let j=this.headers.get("authorization");if(j){let[B,Y]=j.split(" ",2);if(B.trim()=="Bearer")return Y.trim()}}get accept(){return this.headers.get("accept")}get contentType(){return this.headers.get("content-type")}get cookies(){if(!this.__cookies.size){let j=this.headers.get("cookie");if(j){let B=j.split(";").reduce((Y,Q)=>{let[Z,$]=Q.trim().split(/=(.*)/s);return Y.push([Z,$]),Y},[]);this.__cookies=new Map(B)}}return this.__cookies}get headers(){return this.req.headers??new Headers}get ip(){return this.server?.requestIP(this.req)}get isForm(){let j=this.contentType;return j?j.indexOf("multipart/form-data")>=0||j.indexOf("x-www-form-urlencoded")>=0:!1}get isEventStream(){return this.accept?.includes("text/event-stream")}get path(){return this.url.pathname}get parsed(){let{parsed:j}=f(this.path);return j}get searchParams(){return this.url.searchParams}get range(){return this.headers.get("range")??void 0}get isWSS(){return!!this.headers.get("upgrade")}get upgrade(){return this.headers.get("upgrade")}get request(){return this.req}get signal(){return this.req.signal}}x=F([jj,y("design:paramtypes",[typeof Request==="undefined"?Object:Request,typeof lj==="undefined"?Object:lj])],x);class n{j;B;constructor(j,B={}){this.app=j;this.data=B}_head(j){if(!j.startsWith("."))j="."+j;return`<script type="module">import x from "${j}";x.ctx(${JSON.stringify(this.data)});</script>`}async render(j,B){if(A(this.app)){let Y=this._head(this.app);return l("",j+Y,B)}else if("ssr"in this.app){let Y=await this.app.ssr(this.data);return l("",j+Y.script,B,Y.body)}return l("",j,B)}}class c{Y;method;isFile;isEStream;isWSS=!1;z_args={};constructor(j,B,Y="./"){this.apt=Y;let Q=new x(j,B),{parsed:Z,method:$,path:V,isWSS:N,isEventStream:G}=Q,H=Ij({parsed:Z,isWSS:N,path:V});this.isEStream=!!G,this.isWSS=N,this.isFile=H.isFile,this.method=$;let W=dj(Q);Object.defineProperties(this,{req:{get:function(){return Q}},_resp:{get:function(){return W}},maker:{get:function(){return H}}})}push(j,B){let{status:Y,headers:Q}=this.maker;return B??=Y,new Response(j,{status:B,headers:Q})}async processMethod(j){let{maker:B,method:Y,_resp:Q}=this,Z=await j.call(Q,this.z_args);if(typeof Z==="object"&&"error"in Z){B.status=Z.error;return}let{header:$,status:V,headattr:N,lang:G,__session:H}=Q;if(X($))B.header=$;if(V)B.status=V;if(H&&await hj(H,B.headers),!Z){B.status=V??204;return}if(Z instanceof Response)return B.status=Z.status,B.header=Z.headers.toJSON(),await Z.arrayBuffer();if(Y==="post"&&Z instanceof cj)return mj.call(this,Z);if(typeof Z==="object"&&!(Z instanceof n))return B.type="application/json",JSON.stringify(Z);B.type="text/html";let W=[M.headstr,...s(N)].join("");if(Z instanceof n)return await Z.render(W,G);return l(String(Z),W,G)}async response(){let{maker:j,isWSS:B,isFile:Y,isEStream:Q,method:Z,_resp:$}=this,V=j.route;if(!V)return this.push(j.deflate(""));if(this.z_args=Uj(V.args??[],j.x_args),await Xj($,this.z_args,await this.req.authgroup()),Mj(!!V.config.requireSession,this.z_args))return j.status=401,this.push();if(Y)return this.push(await ij.call(this,V));let{proto:N,isWSS:G}=V;if(B&&G){let W=await kj.call(this,V);return this.push(j.deflate(W??""))}let H="eventStream";if(N?.[H]&&Q){let W=await vj.call(this,N[H]);return this.push(W)}if(N?.[Z]){let W=await this.processMethod(N[Z]);return this.push(j.deflate(W??""))}return this.push(j.deflate(""))}}async function mj(j){let B=this.maker,{jwtv:Y,refreshjwt:Q}=await this.req.authgroup(),Z={},$=(N)=>{return B.status=403,{error:N}},V=async(N)=>{let G=U.jwtInt.save(N);return N.access_token=G,await U.jwt.saveSession(N,B.headers),{access_token:G,refresh_token:N.sid,status:"ok"}};if(Q){let N=await U.jwt.openSession(Q),G=N.data.access_token;if(Y!==G)Z=$("tokens don't match.");else if(!U.jwtInt.verify(G,{days:5}))await U.jwt.saveSession(N,void 0,!0),Z=$("expired refresh_token");else Z=await V(N)}else if(!Y&&j.modified)Z=await V(j);else B.status=204;return B.type="application/json",JSON.stringify(Z)}async function Xj(j,B,Y){let Q={},{sid:Z,jwtv:$,refreshjwt:V}=Y;if(Z){if(j.session=await U.session.openSession(Z),!j.session.new)Q.session=!0}if($){if(j.jwt=U.jwtInt.open($,{hours:6}),!j.jwt.new)Q.jwt=!0;if(V){if(!(await U.jwt.openSession(V)).new)Q.jwt_refresh=!0}}if(X(Q))E(B,Q)}async function vj(j){let{req:B,z_args:Y,_resp:Q}=this,Z=this.maker,$=new ReadableStream({async start(N){Q.stream=new h(N),await j.call(Q,Y),B.signal.addEventListener("abort",()=>{if(Q.stream?.close(),Q.stream?.intervalID.length)N.close()})}});Z.header={"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"};let V=await j.call(Q,Y);if(typeof V==="object"&&"error"in V)return Z.status=V.error,"";return $}async function kj(j){let{req:B,z_args:Y}=this,Q=new p(B);if(await Xj(Q,Y,await B.authgroup()),Mj(!!j.config.requireSession,Y))return this.maker.status=401,"";let{broadcast:Z,maxClient:$}=j.config,V=Q.path,N=Dj(V),G=X(N);if(Q.broadcasting=!!Z,Q.max=$??0,$&&G>=$)return"upgrade error";let{open:H,message:W,close:w,init:z}=j.proto;return Q.open=H,Q.message=W,Q.close=w,Q.init=z,this.req.upgradeConnection({data:{wclass:Q,z_args:Y,client:N}}),"upgrade error"}async function ij(j){let B=this.req.range,Y=this.maker,{path:Q,bytes:Z,fileType:$}=j;if(Z)return qj(Z,Z.byteLength,$,Y,B);let V=nj(this.apt+Q);try{let G=$.startsWith("video/")?V:await V.bytes();return qj(G,V.size,$,Y,B)}catch{return Y.status=404,`${Q} file not found.`}}var qj=(j,B,Y,Q,Z)=>{if(Q.type=Y,!Z)return Q.header={"Cache-Control":"max-age=86400, must-revalidate"},Qj(j)?Q.gzip(j):j;let[$,V,N]=Kj(B,Z);return Q.header={"Content-Range":`bytes ${$}-${V}/${N}`,"Content-Length":B.toString()},Q.status=206,j.slice($,V+1)},s=(j)=>{if(!j)return[];return O(j).reduce((B,[Y,Q])=>{if(A(Q))return B.push(`<${Y}>${Q}</${Y}>`),B;if(!Zj(Q))return B;let Z=Q.map(($)=>{if(Y==="script"){let V={...$},N="";if("importmap"in V)V.type="importmap",N=JSON.stringify(V.importmap),delete V.importmap;else if("body"in V)N=V.body,delete V.body;return`<${Y}${Ej(V)}>${N}</${Y}>`}return`<${Y}${Ej($)}>`});return B.push(...Z),B},[])},Ej=(j)=>{return O(j).reduce((B,[Y,Q])=>{return B.push(Yj(Q)?Y:`${Y}="${Q}"`),B},[""]).join(" ")},Mj=(j,B)=>{return j&&!(("session"in B)||("jwt"in B))},l=(j,B,Y,Q)=>{return[`<!DOCTYPE html><html lang="${Y}">`,`<head>${B}</head>`,Q?Q:`<body id="${P(5)}">${j}</body>`,"</html>"].join("")},dj=(j)=>{let B=new d;return Object.defineProperties(B,{request:{get:function(){return j}}}),B},hj=async(j,B)=>{await U.session.saveSession(j,B)};class ej extends M{j;apt;serve;constructor(j="./",B={}){super();this.dir=j;let Y=this.dir+"/.private",{envPath:Q,appDir:Z,session:$}=B;if(!Q)Vj(Y),$j(Y+"/.env",`SECRET_KEY="${P(20)}"`);this.apt=j+"/"+(Z??"app")+"/",aj({path:(Q?Q:Y)+"/.env"});let V=$??new tj({dir:this.dir});U.init(V),this.serve=async(N,G)=>await j0.call(this,N,G)}route(j){return u(j,{},!1,!1)}wss(j,B={}){return u(j,B,!0,!1)}redirect(j,B={}){return new Response("",{status:302,headers:{...B,Location:j}})}folders(...j){j.forEach((B)=>bj(...zj(B)))}files(...j){j.forEach((B)=>{let[Y,Q]=zj(B),Z=Y.replace(/^\.+/,""),$=Z.startsWith("/")?Z:"/"+Z;u($,Q,!1,!0,Q.preload?this.apt:void 0)})}session(...j){return r(j[0],j[2],"session")}jwt(...j){return r(j[0],j[2],"jwt")}jwt_refresh(...j){return r(j[0],j[2],"jwt_refresh")}}async function j0(j,B={}){let{path:Y,hostname:Q,method:Z,port:$}=j;if($??=3000,M.headstr=s(this.headattr).join(""),Y)await Q0({url:`http://${Q??"127.0.0.1"}:${$}${Y}`,method:Z??"GET"},this.apt);else sj({port:j.port,tls:B0(this.dir),fetch:async(V,N)=>{return await new c(V,N,this.apt).response()},websocket:{sendPings:!0,perMessageDeflate:!0,...B,...Oj}})}var B0=(j)=>{return O(process.env).filter(([B])=>B.startsWith("TLS_")).reduce((B,[Y,Q])=>{if(Q){let Z=Y.replace("TLS_","").toLowerCase();B[Z]=oj(j+"/"+Q)}return B},{})},zj=(j)=>{let B=A(j);return[B?j:j[0],B?{}:j[1]]},r=(j,B,Y)=>{let Q=B.value;return B.value=async function(Z={}){if(Y in Z&&Z.session)return Q.call(j,Z);return{error:401}},B},Q0=async(j,B)=>{let Y=await new c(j,void 0,B).response(),Q=pj(await Y.arrayBuffer());Q.byteLength&&rj(B+"index.html",Q)};export{Lj as websocket,Hj as response,n as Render,ej as Raboot,Bj as $$};
